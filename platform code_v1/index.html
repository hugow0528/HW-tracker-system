<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>缺交功課管理平台</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #007aff;
            --secondary-color: #f2f2f7;
            --content-bg: #ffffff;
            --font-color: #1d1d1f;
            --subtle-font-color: #6e6e73;
            --border-color: #d1d1d6;
            --shadow-color: rgba(60, 64, 67, 0.1);
            --shadow-hover-color: rgba(60, 64, 67, 0.2);
            --danger-color: #ff3b30;
            --success-color: #34c759;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --border-radius-large: 16px;
            --border-radius-medium: 12px;
            --border-radius-small: 8px;
        }

        html { box-sizing: border-box; }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: var(--font-family);
            background-color: var(--secondary-color);
            color: var(--font-color);
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease;
        }

        .wrapper {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            max-width: 1280px;
            margin: 32px auto;
            padding: 0 24px;
            width: 100%;
            flex-grow: 1;
        }

        h1, h2 {
            text-align: center;
            animation: fadeInDown 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            margin: 0 0 24px 0;
        }

        h1 {
            color: var(--font-color);
            font-weight: 700;
            font-size: 2.5rem;
        }

        h2 {
            color: var(--subtle-font-color);
            font-weight: 500;
            font-size: 1.25rem;
            margin-top: -16px;
            margin-bottom: 40px;
        }

        /* Home View */
        #home-view { padding: 40px 20px; }
        .grade-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        .grade-button {
            background-color: var(--content-bg);
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 28px;
            border-radius: var(--border-radius-large);
            font-size: 1.75em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .grade-button:hover {
            transform: translateY(-6px);
            border-color: var(--primary-color);
            box-shadow: 0 8px 16px var(--shadow-hover-color);
        }

        /* Dashboard View */
        #dashboard-view { display: none; }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .icon-button {
            background: var(--content-bg);
            color: var(--primary-color);
            padding: 12px 18px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease-out;
            box-shadow: 0 1px 2px var(--shadow-color);
        }
        
        .icon-button:hover {
            background-color: #e5e5ea;
            transform: translateY(-2px);
            box-shadow: 0 2px 4px var(--shadow-hover-color);
        }

        .icon-button svg { width: 1.3em; height: 1.3em; }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
            padding: 24px;
            background: var(--content-bg);
            border-radius: var(--border-radius-large);
            border: 1px solid var(--border-color);
        }

        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 8px; font-weight: 500; font-size: 0.9em; color: var(--subtle-font-color); }
        
        select, input[type="text"] {
            padding: 12px;
            border-radius: var(--border-radius-small);
            border: 1px solid var(--border-color);
            font-size: 1em;
            background-color: #f2f2f7;
            width: 100%;
            transition: all 0.2s ease-out;
        }
        
        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: var(--content-bg);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
        }

        #loader { display: none; text-align: center; padding: 60px; }
        .spinner { border: 6px solid #e5e5ea; border-top: 6px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 16px; }

        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 24px; animation: fadeInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        
        .student-card {
            background: var(--content-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-large);
            padding: 24px;
            box-shadow: 0 2px 4px var(--shadow-color);
            transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .student-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 8px 16px var(--shadow-hover-color);
        }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 16px; }
        .student-info { font-size: 1.4em; font-weight: 600; color: var(--font-color); }
        .total-count { background-color: var(--danger-color); color: white; padding: 5px 12px; border-radius: 99px; font-size: 0.9em; font-weight: 600; flex-shrink: 0; margin-left: 10px; }
        
        .record-list { list-style-type: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .record-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: var(--border-radius-small); transition: background-color 0.2s; }
        .record-item:not(:last-child) { margin-bottom: 8px; }
        .record-item:nth-child(odd) { background-color: #f2f2f7; }
        
        .record-details { line-height: 1.5; }
        .record-subject { font-weight: 600; }
        .record-homework { color: var(--subtle-font-color); font-size: 0.95em; }
        .record-date { font-size: 0.85em; color: var(--subtle-font-color); margin-top: 4px; }
        
        .delete-btn {
            background-color: transparent;
            color: var(--subtle-font-color);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            transition: all 0.2s ease-out;
            flex-shrink: 0;
            margin-left: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-btn:hover {
            background-color: #ff3b3020;
            color: var(--danger-color);
        }
        .delete-btn svg { width: 1.4em; height: 1.4em; }

        #toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background-color: #2c2c2e; color: white; padding: 16px 28px; border-radius: var(--border-radius-large); visibility: hidden; opacity: 0; transform: translate(-50%, 10px); transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%); }

        .footer { text-align: center; padding: 32px 16px; color: var(--subtle-font-color); font-size: 0.9em; }

        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) { h1 {font-size: 2rem;} h2 {font-size: 1.1rem;} .container { margin: 24px auto; padding: 0 16px;} }
        @media (max-width: 480px) { h1 {font-size: 1.8em;} .filters {padding: 16px;} .student-card{padding:16px;} .dashboard-header { justify-content: center; } }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="container">
            <!-- Home View -->
            <div id="home-view">
                <h1>缺交功課管理平台</h1>
                <h2>請選擇要查看的年級</h2>
                <div class="grade-selection-grid">
                    <button class="grade-button" onclick="showDashboardView('中一')">中一</button>
                    <button class="grade-button" onclick="showDashboardView('中二')">中二</button>
                    <button class="grade-button" onclick="showDashboardView('中三')">中三</button>
                    <button class="grade-button" onclick="showDashboardView('中四')">中四</button>
                    <button class="grade-button" onclick="showDashboardView('中五')">中五</button>
                    <button class="grade-button" onclick="showDashboardView('中六')">中六</button>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view">
                <div class="dashboard-header">
                    <button class="icon-button" onclick="showHomeView()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>
                        返回主頁
                    </button>
                    <h1 id="dashboard-title"></h1>
                    <div class="header-actions">
                        <a id="view-student-list-btn" class="icon-button" href="#" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.412A9.957 9.957 0 0010 18c2.31 0 4.438-.784 6.131-2.095a1.23 1.23 0 00.41-1.412A9.995 9.995 0 0010 12c-2.31 0-4.438.784-6.131 2.095z" /></svg>
                            查看學生名單
                        </a>
                        <a id="open-form-btn" class="icon-button" href="#" target="_blank" rel="noopener noreferrer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M16.22 3.22a.75.75 0 011.06 0l.53.53a.75.75 0 010 1.06l-10.124 10.124a.75.75 0 01-.383.22l-2.5.5a.75.75 0 01-.83-1.182l1-3.5a.75.75 0 01.22-.384L15.16 3.22zm2.02-2.02a2.25 2.25 0 010 3.182L5.426 15.194a2.25 2.25 0 01-1.157 1.018l-3.25 1.159a.75.75 0 01-.975-.975l1.159-3.25a2.25 2.25 0 011.018-1.157L15.194 1.426a2.25 2.25 0 013.046.002z" /></svg>
                            開啟記錄表單
                        </a>
                        <button class="icon-button" onclick="fetchData()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.201-4.456 5.5 5.5 0 011.18-1.025A.75.75 0 016 4.44v1.44a.75.75 0 01-1.5 0V4.44c0-.596.326-1.126.845-1.421A7.001 7.001 0 0116.5 9.5a7 7 0 01-1.188 3.924.75.75 0 01-1.214-.888zM4.12 6.576A5.5 5.5 0 0113.25 11h-1.44a.75.75 0 010-1.5h1.44a5.503 5.503 0 01-1.472-3.414.75.75 0 011.423-.432A7.001 7.001 0 013.5 9.5a7 7 0 011.214-3.924.75.75 0 011.214.888A5.5 5.5 0 014.12 6.576z" clip-rule="evenodd" /></svg>
                            刷新資料
                        </button>
                    </div>
                </div>
                <div class="filters">
                    <div class="filter-group"><label for="subclass-filter">班別</label><select id="subclass-filter" onchange="applyFilters()"><option value="">所有班別</option></select></div>
                    <div class="filter-group"><label for="student-filter">學號</label><input type="text" id="student-filter" placeholder="輸入學號..." oninput="applyFilters()"></div>
                    <div class="filter-group"><label for="subject-filter">科目</label><select id="subject-filter" onchange="applyFilters()"><option value="">所有科目</option></select></div>
                </div>
                <div id="loader"><div class="spinner"></div><p>正在載入資料...</p></div>
                <div id="results"></div>
            </div>
        </div>
        <footer class="footer">Copyright © 2025 Wong Tsz Him, Hugo. All rights reserved.</footer>
    </div>
    <div id="toast"></div>

    <script>
        let allRecords = [];
        let platformData = {};
        let currentGrade = null;
        const initialGrade = "<?!= grade ?>";

        document.addEventListener('DOMContentLoaded', () => {
            if (initialGrade) { showDashboardView(initialGrade); } else { showHomeView(); }
        });

        function showHomeView() {
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('dashboard-view').style.display = 'none';
            window.history.pushState({}, '', window.location.pathname);
        }

        function showDashboardView(grade) {
            currentGrade = grade;
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('dashboard-view').style.display = 'block';
            document.getElementById('dashboard-title').textContent = `${grade} 缺交記錄`;
            window.history.pushState({grade: grade}, '', `?grade=${grade}`);
            fetchData();
        }

        function fetchData() {
            if (!currentGrade) return;
            showLoader(true);
            google.script.run
                .withSuccessHandler(onDataLoaded)
                .withFailureHandler(onFailure)
                .getPlatformData(currentGrade);
        }

        function onDataLoaded(data) {
            platformData = data;
            allRecords = data.records;
            populateFilters();
            applyFilters();
            updateDashboardLinks();
            showLoader(false);
        }
        
        function populateFilters() {
            const subClassFilter = document.getElementById('subclass-filter');
            const studentFilter = document.getElementById('student-filter');
            const subjectFilter = document.getElementById('subject-filter');
            subClassFilter.innerHTML = '<option value="">所有班別</option>';
            studentFilter.value = '';
            subjectFilter.innerHTML = '<option value="">所有科目</option>';
            platformData.filters.subClasses.forEach(c => subClassFilter.add(new Option(c, c)));
            platformData.filters.subjects.forEach(s => subjectFilter.add(new Option(s, s)));
        }
        
        function updateDashboardLinks() {
            document.getElementById('view-student-list-btn').href = platformData.studentListUrl || '#';
            document.getElementById('open-form-btn').href = platformData.formUrl || '#';
        }
        
        function applyFilters() {
            const subClassValue = document.getElementById('subclass-filter').value;
            const studentValue = document.getElementById('student-filter').value.trim();
            const subjectValue = document.getElementById('subject-filter').value;
            let filteredRecords = allRecords.filter(r => 
                (subClassValue === "" || r.subClass === subClassValue) &&
                (studentValue === "" || r.studentId.includes(studentValue)) &&
                (subjectValue === "" || r.subject === subjectValue)
            );
            renderResults(filteredRecords);
        }

        function renderResults(records) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            if (records.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align:center; color: var(--subtle-font-color); padding: 40px;">沒有符合條件的紀錄。</p>';
                return;
            }
            const groupedByStudent = records.reduce((acc, record) => {
                const key = `${record.subClass}班 - ${record.studentId}號`;
                if (!acc[key]) { acc[key] = []; }
                acc[key].push(record);
                return acc;
            }, {});
            const resultsGrid = document.createElement('div');
            resultsGrid.className = 'results-grid';
            const sortedKeys = Object.keys(groupedByStudent).sort((a, b) => {
                const [classA, studentA] = a.split(' - ');
                const [classB, studentB] = b.split(' - ');
                if (classA.localeCompare(classB) !== 0) { return classA.localeCompare(classB, 'zh-HK'); }
                return parseInt(studentA) - parseInt(studentB);
            });
            for (const key of sortedKeys) {
                const studentRecords = groupedByStudent[key];
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                // ✨ UPDATED: Replaced delete button with a proper SVG icon
                studentCard.innerHTML = `
                    <div class="card-header">
                        <span class="student-info">${key}</span>
                        <span class="total-count">總計: ${studentRecords.length} 次</span>
                    </div>
                    <ul class="record-list">
                        ${studentRecords.sort((a,b) => new Date(b.date) - new Date(a.date)).map(record => `
                            <li class="record-item">
                                <div class="record-details">
                                    <div class="record-subject">${record.subject}</div>
                                    <div class="record-homework">${record.homeworkName || '(未命名)'}</div>
                                    <div class="record-date">${record.date}</div>
                                </div>
                                <button class="delete-btn" onclick="confirmDelete('${record.id}')" title="刪除此紀錄">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.58.22-2.365.468a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.84 0a.75.75 0 01-1.498.06l-.3 7.5a.75.75 0 111.498-.06l.3-7.5z" clip-rule="evenodd" /></svg>
                                </button>
                            </li>
                        `).join('')}
                    </ul>`;
                resultsGrid.appendChild(studentCard);
            }
            resultsDiv.appendChild(resultsGrid);
        }

        function confirmDelete(id) {
            if (confirm('您確定要永久刪除這筆紀錄嗎？')) {
                showLoader(true);
                google.script.run.withSuccessHandler(onDeleteSuccess).withFailureHandler(onFailure).deleteRecord(id);
            }
        }
        function onDeleteSuccess(response) {
            showToast(response.message, response.success);
            if (response.success) { fetchData(); } else { showLoader(false); }
        }
        function onFailure(error) {
            showLoader(false);
            showToast('操作失敗: ' + error.message, false);
        }
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = isSuccess ? 'var(--success-color)' : 'var(--danger-color)';
            toast.className = 'show';
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
        }
    </script>
</body>
</html>
